package image

import (
	"image"
	"image/color"

	"golang.org/x/image/draw"
)

// AddText adds text to an image
func (p *Processor) AddText(img image.Image, text string, x, y, fontSize int, textColorStr string) image.Image {
	bounds := img.Bounds()
	newImg := image.NewRGBA(bounds)
	draw.Draw(newImg, bounds, img, bounds.Min, draw.Src)

	// Parse color
	tc := parseColor(textColorStr)

	// Draw text
	p.drawText(newImg, text, x, y, fontSize, tc)

	return newImg
}

// drawText draws text on image (using simple bitmap font)
func (p *Processor) drawText(img *image.RGBA, text string, x, y, fontSize int, textColor color.RGBA) {
	// Simple 7x13 bitmap font implementation
	charWidth := fontSize * 7 / 13
	charHeight := fontSize
	if charWidth < 1 {
		charWidth = 1
	}
	if charHeight < 1 {
		charHeight = 1
	}

	// Draw each character
	dx := 0
	for _, r := range text {
		charX := x + dx
		charY := y

		// Draw character
		p.drawChar(img, r, charX, charY, charWidth, charHeight, textColor)

		dx += charWidth + 1 // Character spacing
	}
}

// drawChar draws a single character (using simple 7x13 bitmap font)
func (p *Processor) drawChar(img *image.RGBA, r rune, x, y, width, height int, c color.RGBA) {
	// Get character bitmap data
	charData := getCharBitmap(r)
	if charData == nil {
		return
	}

	scaleX := float64(width) / 7.0
	scaleY := float64(height) / 13.0

	// Draw character
	for py := 0; py < 13; py++ {
		for px := 0; px < 7; px++ {
			if charData[py]&(1<<uint(6-px)) != 0 {
				// Scale drawing
				startX := int(float64(px) * scaleX)
				startY := int(float64(py) * scaleY)
				endX := int(float64(px+1) * scaleX)
				endY := int(float64(py+1) * scaleY)

				for sy := startY; sy < endY; sy++ {
					for sx := startX; sx < endX; sx++ {
						imgX := x + sx
						imgY := y + sy

						if imgX >= 0 && imgX < img.Bounds().Dx() && imgY >= 0 && imgY < img.Bounds().Dy() {
							if c.A == 255 {
								img.Set(imgX, imgY, c)
							} else {
								oldR, oldG, oldB, oldA := img.At(imgX, imgY).RGBA()
								alpha := float64(c.A) / 255.0
								newR := uint8(float64(c.R)*alpha + float64(oldR>>8)*(1-alpha))
								newG := uint8(float64(c.G)*alpha + float64(oldG>>8)*(1-alpha))
								newB := uint8(float64(c.B)*alpha + float64(oldB>>8)*(1-alpha))
								img.Set(imgX, imgY, color.RGBA{newR, newG, newB, uint8(oldA >> 8)})
							}
						}
					}
				}
			}
		}
	}
}

// getCharBitmap gets character 7x13 bitmap data
func getCharBitmap(r rune) []uint8 {
	char := byte(r)

	// Complete ASCII character bitmap data (7x13 format, one byte per row)
	fontData := map[byte][]uint8{
		' ': {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
		'!': {0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x00, 0x10, 0x00, 0x00, 0x00},
		'0': {0x38, 0x44, 0x4C, 0x54, 0x64, 0x44, 0x38, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
		'1': {0x10, 0x30, 0x10, 0x10, 0x10, 0x10, 0x38, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
		'2': {0x38, 0x44, 0x04, 0x08, 0x10, 0x20, 0x7C, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
		'3': {0x38, 0x44, 0x04, 0x18, 0x04, 0x44, 0x38, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
		'4': {0x08, 0x18, 0x28, 0x48, 0x7C, 0x08, 0x08, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
		'5': {0x7C, 0x40, 0x78, 0x04, 0x04, 0x44, 0x38, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
		'6': {0x38, 0x44, 0x40, 0x78, 0x44, 0x44, 0x38, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
		'7': {0x7C, 0x04, 0x08, 0x10, 0x10, 0x20, 0x20, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
		'8': {0x38, 0x44, 0x44, 0x38, 0x44, 0x44, 0x38, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
		'9': {0x38, 0x44, 0x44, 0x3C, 0x04, 0x44, 0x38, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
		'A': {0x10, 0x28, 0x44, 0x44, 0x7C, 0x44, 0x44, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
		'B': {0x78, 0x44, 0x44, 0x78, 0x44, 0x44, 0x78, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
		'C': {0x38, 0x44, 0x40, 0x40, 0x40, 0x44, 0x38, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
		'D': {0x78, 0x44, 0x44, 0x44, 0x44, 0x44, 0x78, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
		'E': {0x7C, 0x40, 0x40, 0x78, 0x40, 0x40, 0x7C, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
		'F': {0x7C, 0x40, 0x40, 0x78, 0x40, 0x40, 0x40, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
		'G': {0x38, 0x44, 0x40, 0x4C, 0x44, 0x44, 0x38, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
		'H': {0x44, 0x44, 0x44, 0x7C, 0x44, 0x44, 0x44, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
		'I': {0x38, 0x10, 0x10, 0x10, 0x10, 0x10, 0x38, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
		'J': {0x1C, 0x08, 0x08, 0x08, 0x08, 0x48, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
		'K': {0x44, 0x48, 0x50, 0x60, 0x50, 0x48, 0x44, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
		'L': {0x40, 0x40, 0x40, 0x40, 0x40, 0x40, 0x7C, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
		'M': {0x44, 0x6C, 0x54, 0x54, 0x44, 0x44, 0x44, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
		'N': {0x44, 0x64, 0x54, 0x4C, 0x44, 0x44, 0x44, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
		'O': {0x38, 0x44, 0x44, 0x44, 0x44, 0x44, 0x38, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
		'P': {0x78, 0x44, 0x44, 0x78, 0x40, 0x40, 0x40, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
		'Q': {0x38, 0x44, 0x44, 0x44, 0x54, 0x48, 0x34, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
		'R': {0x78, 0x44, 0x44, 0x78, 0x50, 0x48, 0x44, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
		'S': {0x38, 0x44, 0x40, 0x38, 0x04, 0x44, 0x38, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
		'T': {0x7C, 0x10, 0x10, 0x10, 0x10, 0x10, 0x10, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
		'U': {0x44, 0x44, 0x44, 0x44, 0x44, 0x44, 0x38, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
		'V': {0x44, 0x44, 0x44, 0x44, 0x44, 0x28, 0x10, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
		'W': {0x44, 0x44, 0x44, 0x54, 0x54, 0x6C, 0x44, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
		'X': {0x44, 0x44, 0x28, 0x10, 0x28, 0x44, 0x44, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
		'Y': {0x44, 0x44, 0x44, 0x28, 0x10, 0x10, 0x10, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
		'Z': {0x7C, 0x04, 0x08, 0x10, 0x20, 0x40, 0x7C, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
		'a': {0x00, 0x00, 0x38, 0x04, 0x3C, 0x44, 0x3C, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
		'b': {0x40, 0x40, 0x78, 0x44, 0x44, 0x44, 0x78, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
		'c': {0x00, 0x00, 0x38, 0x44, 0x40, 0x44, 0x38, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
		'd': {0x04, 0x04, 0x3C, 0x44, 0x44, 0x44, 0x3C, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
		'e': {0x00, 0x00, 0x38, 0x44, 0x7C, 0x40, 0x38, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
		'f': {0x18, 0x24, 0x20, 0x78, 0x20, 0x20, 0x20, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
		'g': {0x00, 0x00, 0x3C, 0x44, 0x44, 0x3C, 0x04, 0x38, 0x00, 0x00, 0x00, 0x00, 0x00},
		'h': {0x40, 0x40, 0x78, 0x44, 0x44, 0x44, 0x44, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
		'i': {0x10, 0x00, 0x30, 0x10, 0x10, 0x10, 0x38, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
		'j': {0x08, 0x00, 0x18, 0x08, 0x08, 0x08, 0x48, 0x30, 0x00, 0x00, 0x00, 0x00, 0x00},
		'k': {0x40, 0x40, 0x48, 0x50, 0x60, 0x50, 0x48, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
		'l': {0x30, 0x10, 0x10, 0x10, 0x10, 0x10, 0x38, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
		'm': {0x00, 0x00, 0x68, 0x54, 0x54, 0x44, 0x44, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
		'n': {0x00, 0x00, 0x78, 0x44, 0x44, 0x44, 0x44, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
		'o': {0x00, 0x00, 0x38, 0x44, 0x44, 0x44, 0x38, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
		'p': {0x00, 0x00, 0x78, 0x44, 0x44, 0x78, 0x40, 0x40, 0x00, 0x00, 0x00, 0x00, 0x00},
		'q': {0x00, 0x00, 0x3C, 0x44, 0x44, 0x3C, 0x04, 0x04, 0x00, 0x00, 0x00, 0x00, 0x00},
		'r': {0x00, 0x00, 0x58, 0x64, 0x40, 0x40, 0x40, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
		's': {0x00, 0x00, 0x38, 0x40, 0x38, 0x04, 0x38, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
		't': {0x20, 0x20, 0x78, 0x20, 0x20, 0x24, 0x18, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
		'u': {0x00, 0x00, 0x44, 0x44, 0x44, 0x44, 0x3C, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
		'v': {0x00, 0x00, 0x44, 0x44, 0x44, 0x28, 0x10, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
		'w': {0x00, 0x00, 0x44, 0x44, 0x54, 0x54, 0x28, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
		'x': {0x00, 0x00, 0x44, 0x28, 0x10, 0x28, 0x44, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
		'y': {0x00, 0x00, 0x44, 0x44, 0x44, 0x3C, 0x04, 0x38, 0x00, 0x00, 0x00, 0x00, 0x00},
		'z': {0x00, 0x00, 0x7C, 0x08, 0x10, 0x20, 0x7C, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
		'.': {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x10, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
		',': {0x00, 0x00, 0x00, 0x00, 0x00, 0x08, 0x10, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
		':': {0x00, 0x00, 0x10, 0x00, 0x00, 0x00, 0x10, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
		';': {0x00, 0x00, 0x10, 0x00, 0x00, 0x08, 0x10, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
		'-': {0x00, 0x00, 0x00, 0x00, 0x7C, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
		'_': {0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x7C, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00},
	}

	// Direct lookup
	if data, ok := fontData[char]; ok {
		if len(data) < 13 {
			result := make([]uint8, 13)
			copy(result, data)
			return result
		}
		return data
	}

	// For other characters, use simple placeholder
	return []uint8{
		0b0111110,
		0b1000001,
		0b1000001,
		0b1000001,
		0b1000001,
		0b1000001,
		0b1000001,
		0b1000001,
		0b1000001,
		0b1000001,
		0b1000001,
		0b1000001,
		0b0111110,
	}
}
